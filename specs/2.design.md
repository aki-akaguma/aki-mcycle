# `aki-mcycle` Design Document

## 1. Introduction

This document describes the software design for the `aki-mcycle` command-line utility. It details the high-level architecture and component breakdown, linking the design back to the acceptance criteria defined in `specs/1.acceptance-criteria.md`.

## 2. High-Level Architecture

`aki-mcycle` is a command-line application written in Rust. It follows a simple, modular, and stream-based architecture. The primary design pattern is a pipeline that reads from standard input, processes the data, and writes to standard output.

### Data Flow Diagram

The data flow is linear:

```
[ Stdin ] -> [ main.rs ] -> [ conf::parse ] (Parses CLI Options)
     |             |
     |             v
     |       [ run::execute ] (Core Logic)
     |             |
     |             v
     |       (Reads Color Env Vars or uses Defaults)
     |             |
     |             v
     |       (Applies Regex and Coloring)
     |             |
     |             v
     +------> [ Stdout ]
```

## 3. Component Breakdown

The application is broken down into several modules, each with a distinct responsibility.

### 3.1. `main.rs`: Application Entry Point

- **Responsibility:** Serves as the executable's entry point. It initializes the application, parses command-line arguments by calling the `conf` module, invokes the core processing logic from the `run` module, and handles any top-level errors that propagate up.
- **Maps to Acceptance Criteria:**
    - Indirectly supports all criteria by orchestrating the application flow.

### 3.2. `conf` module: Configuration and CLI Parsing

- **Responsibility:** This module defines the entire command-line interface using the `clap` crate. The `conf::parse::CmdOpt` struct defines all valid arguments and flags.
- **Design:** It uses `clap`'s derive macro to automatically generate the parser from the struct definition.
- **Maps to Acceptance Criteria:**
    - **AC6, AC7:** The `-H`/`--help` and `-V`/`--version` flags are defined here.
    - **AC8, AC9:** The `-e`/`--exp` option and its default value are defined and parsed in this module.

### 3.3. `run.rs`: Core Processing Logic

- **Responsibility:** Contains the `execute` function, which is the heart of the application. It performs all data processing.
- **Design:** 
    1.  Reads all data from `io::stdin()` into a buffer.
    2.  Initializes a color cycler. It checks for the presence of `AKI_MCYCLE_COLOR_SEQ_*` environment variables. If they are not set, it falls back to a hardcoded default array of ANSI color codes.
    3.  Compiles the regular expression provided via the `CmdOpt` configuration.
    4.  Uses `regex.find_iter()` to iterate through all non-overlapping matches in the input text.
    5.  Builds the output string by appending the text between matches and the colored text for each match. The color is selected by cycling through the color array.
    6.  Prints the final constructed string to `io::stdout()`.
- **Maps to Acceptance Criteria:**
    - **AC1:** Reads from `io::stdin()`.
    - **AC2:** Uses the `regex` crate to find all matches.
    - **AC3:** Iterates through a color array for each match.
    - **AC4:** Prints the final string to `io::stdout()`.
    - **AC5:** The logic naturally handles the no-match case by simply not entering the match loop, resulting in the original text being printed.
    - **AC10, AC11:** Explicitly checks for environment variables and falls back to defaults.

### 3.4. `util/err.rs`: Error Handling

- **Responsibility:** Defines the application's custom error type, `AkiMcycleError`.
- **Design:** It's an enum that covers potential failure modes, such as I/O errors or regex parsing errors. This allows for specific and informative error handling rather than generic panics.
- **Maps to Acceptance Criteria:** Supports all criteria by providing a robust error-handling mechanism.

### 3.5. `lib.rs`: Library Interface

- **Responsibility:** Exposes the `run::execute` function and the `util::err::AkiMcycleError` type, making the application's core logic available for use as a library in other Rust projects.
- **Design:** It declares the `run` and `util` modules and uses `pub use` to create a clean public API.
